<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Eè­·å°å¹«æ‰‹ ä»»å‹™ç®¡ç†</title>
  <style>
    /* åŸºæœ¬æ’ç‰ˆ */
    body {
      font-family: 'Arial', sans-serif;
      margin: 20px;
      background: #f4f4f4;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .container {
      display: flex;
      width: 100%;
      /* max-width: 1200px; */
      background: #fff;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      border-radius: 8px;
      overflow: hidden;
    }

    .main {
      width: 70%;
      padding: 20px;
      border-right: 1px solid #e0e0e0;
    }

    .sidebar {
      width: 15%;
      padding: 20px;
      border-right: 1px solid #e0e0e0;
    }

    .sidebar:last-child {
      border-right: none;
    }

    h1 {
      margin-top: 0;
      text-align: center;
    }

    /* Tabs èˆ‡ Temi åˆ‡æ›æŒ‰éˆ• */
    .tabs,
    .temis {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      justify-content: center;
    }

    .tab-button,
    .temi-button {
      padding: 10px 15px;
      border: none;
      background: #ddd;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.2s ease;
    }

    .tab-button.active,
    .temi-button.active {
      background: #007bff;
      color: #fff;
    }

    /* å…§å®¹å€åŸŸ */
    .tab-content {
      padding: 20px;
      border: 1px solid #ddd;
      background: #fafafa;
      border-radius: 4px;
      min-height: 400px;
    }

    /* èµ°å»Šã€æˆ¿é–“ã€åºŠä½ */
    /* .hallway {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .side {
      width: 48%;
      height: fit-content;
    }
    .room {
      border: 1px solid #ccc;
      padding: 10px;
      width: 200px;
      height: fit-content;
      margin-bottom: 20px;
      background: #fff;
      border-radius: 4px;
    } */
    /* æ›´æ–°å¾Œçš„ CSS */
    .hallway {
      display: flex;
      flex-direction: column;
      gap: 20px;
      /* å¯é¸ï¼Œç”¨ä¾†å¢åŠ èµ°å»Šä¹‹é–“çš„é–“è· */
    }

    .side {
      display: flex;
      flex-wrap: wrap;
      /* å…è¨± room æ›è¡Œ */
      gap: 20px;
      /* é–“è·å¯ä¾éœ€æ±‚èª¿æ•´ */
      justify-content: flex-start;
    }

    .room {
      border: 1px solid #ccc;
      padding: 10px;
      width: fit-content;
      /* å›ºå®šå¯¬åº¦ */
      background: #fff;
      border-radius: 4px;
      /* ç§»é™¤åŸå…ˆçš„ margin-bottomï¼Œæ”¹ç”¨ gap ç®¡ç†é–“è· */
    }

    .room h3 {
      margin-top: 0;
      font-size: 0.8em;
    }

    /* åºŠä½ UI èª¿æ•´ */
    .bed {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 50px;
      height: 30px;
      margin: 5px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      position: relative;
      background-color: #f0f0f0;
      box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
      padding-left: 35px;
      transition: background 0.2s ease;
    }

    /* .bed.service::before {
      content: "ğŸ¥";
      position: absolute;
      left: 5px;
      font-size: 20px;
    }
    .bed.empty::before {
      content: "ğŸ›ï¸";
      position: absolute;
      left: 5px;
      font-size: 20px;
    }
    .bed.ocupied::before {
      content: "ğŸ›Œ";
      position: absolute;
      left: 5px;
      font-size: 20px;
    } */
    /* åºŠä½ç‹€æ…‹ */
    /* .bed.service { background-color: #ed9e3c; }
    .bed.empty { background-color: #bfbfbf; }
    .bed.ocupied { background-color: #77729c; } */

    .bed.service::before,
    .bed.empty::before,
    .bed.ocupied::before {
      content: attr(data-icon);
      /* é€šè¿‡ data-icon å­˜æ”¾ä¸åŒçš„ emoji */
      position: absolute;
      left: 5px;
      top: 50%;
      transform: translateY(-50%);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 4px;
      /* æˆ– 50% åšåœ†å½¢ */
      font-size: 16px;
      line-height: 1;
      color: #fff;
      /* Emoji å‰æ™¯è‰² */
    }

    /* ç©ºåºŠï¼šå°è“å— ğŸ›ï¸ */
    .bed.empty::before {
      background-color: #17a2b8;
      content: "ğŸ›ï¸";
    }

    /* æœ‰ç—…æ‚£ï¼šå°æ©˜å— ğŸ›Œ */
    .bed.ocupied::before {
      background-color: #fd7e14;
      content: "ğŸ›Œ";
    }

    /* æŠ¤ç†ç«™ï¼šå°ç»¿å— ğŸ¥ */
    .bed.service::before {
      background-color: #28a745;
      content: "ğŸ¥";
    }

    .bed.task_empty {
      background-color: #a4a48c;
    }

    .bed.task_pending {
      background-color: #e0d865;
    }

    .bed.task_ongoing {
      background-color: #6ec36e;
    }

    .bed.task_complete {
      background-color: #a4a48c;
    }

    .bed.task_failed {
      background-color: #f44b12;
    }

    .bed.task_new {
      background-color: #f1b3b6;
    }

    .bed.task_moved {
      background-color: #b3f1ee;
    }

    .bed.task_pending.task_new {
      background-color: #f0a122;
    }

    .bed.task_pending.task_moved {
      background-color: #f0a122;
    }

    .bed.task_pending.task_deleted {
      background-color: #f0a122;
    }

    .bed.selected {
      outline: 3px solid #007bff;
    }

    #bed-selection-actions {
      margin-top: 15px;
      /* ä¸Šæ–¹ç•™ç‚¹ç©ºéš™ */
      text-align: center;
      /* æŒ‰é’®æ°´å¹³å±…ä¸­ */
    }

    #bed-selection-actions .submit-btn {
      display: inline-block;
      width: auto;
      margin: 0 5px;
    }

    /* ä»»å‹™æ¸…å–®å€å¡Š */
    .task-list {
      background: #fafafa;
      border: 1px solid #ddd;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 4px;
      max-height: fit-content;
      overflow-y: auto;
    }

    .task-list h2 {
      margin-top: 0;
      text-align: center;
      font-size: medium;
    }

    .task-item {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
      background: #fff;
      border-radius: 4px;
      position: relative;
      cursor: move;
      font-size: 0.8em;
    }

    .task-item h3 {
      margin: 0;
      font-size: 0.8em;
      display: inline-block;
    }

    /* ä»»åŠ¡æ¡ç›®åˆ—è¡¨å®¹å™¨ */
    .task-entries {
      list-style: none;
      /* å»é™¤é»˜è®¤çš„åœ†ç‚¹ */
      padding: 0;
      /* å»æ‰å†…è¾¹è· */
      margin: 0;
      /* å»æ‰å¤–è¾¹è· */
    }

    /* å•å€‹ä»»åŠ¡æ¡ç›® */
    .task-entry {
      padding: 8px 10px;
      /* ä¸Šä¸‹ 8pxï¼Œå·¦å³ 10px å†…è¾¹è· */
      border-bottom: 1px solid #eee;
      /* ä¸‹è¾¹æ¡†åˆ†éš” */
      font-size: 0.9em;
      /* å­—ä½“ç•¥å° */
    }

    .task-entry.new {
      font-weight: bold;
    }

    .task-entry.render {
      font-style: italic;
    }

    /* å¦‚æœæƒ³å»æ‰æœ€åä¸€æ¡çš„ä¸‹è¾¹æ¡† */
    .task-entries .task-entry:last-child {
      border-bottom: none;
    }

    /* åˆªé™¤æŒ‰éˆ• */
    .remove-btn {
      float: right;
      background: transparent;
      border: none;
      color: red;
      cursor: pointer;
      font-size: 14px;
    }

    /* Submit æŒ‰éˆ• */
    .submit-btn {
      display: block;
      width: 100%;
      padding: 10px;
      border: none;
      background: #007bff;
      color: #fff;
      cursor: pointer;
      border-radius: 5px;
      transition: background 0.2s ease;
      margin-top: 10px;
    }

    .submit-btn:hover {
      background: #0056b3;
    }

    /* Modal ä»»å‹™é¸æ“‡è¦–çª— */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      width: 80%;
    }

    .modal-buttons {
      margin: 15px 0;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }

    .modal-task-btn {
      padding: 10px 15px;
      border: none;
      background: #007bff;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
      width: 200px;
    }

    .modal-task-btn:hover {
      background: #0056b3;
    }

    .modal-task-btn.selected {
      background: #0056b3;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.5);
      transform: scale(1.05);
    }

    #task-selection-actions {
      margin-top: 15px;
      /* ä¸Šæ–¹ç•™ç‚¹ç©ºéš™ */
      text-align: center;
      /* æŒ‰é’®æ°´å¹³å±…ä¸­ */
    }

    #task-selection-actions .submit-btn {
      display: inline-block;
      /* è¡Œå†…å—ï¼Œå¯è®¾ç½®å®½é«˜å†…å¤–è· */
      width: auto;
      /* å®½åº¦éšå†…å®¹è‡ªé€‚åº” */
      margin: 0 5px;
      /* å·¦å³å„ 5px é—´éš”ï¼Œä¸Šä¸‹æ— é—´éš” */
    }

    /* æ‹–æ›³æ•ˆæœ */
    .dragging {
      opacity: 0.5;
    }

    /* æ¯å€‹åºŠä½ä»»åŠ¡ç»„å®¹å™¨ */
    .task-group {
      border: 1px solid #ccc;
      /* è¾¹æ¡† */
      border-radius: 4px;
      /* åœ†è§’ */
      background: #fff;
      /* èƒŒæ™¯è‰² */
      padding: 10px;
      /* å†…è¾¹è· */
      margin-bottom: 10px;
      /* åº•éƒ¨å¤–è¾¹è· */
      cursor: move;
      /* å¯æ‹–æ‹½æ—¶çš„å…‰æ ‡æ ·å¼ */
      transition: background 0.2s;
    }

    .task-group.task_pending {
      background-color: #e0d865;
    }

    .task-group.task_ongoing {
      background-color: #6ec36e;
    }

    .task-group.task_complete {
      background-color: #a4a48c;
    }

    .task-group.task_failed {
      background-color: #f44b12;
    }

    .task-group.task_new {
      background-color: #f1b3b6;
    }

    .task-group.task_moved {
      background-color: #b3f1ee;
    }

    .task-group.task_pending.task_new {
      background-color: #f0a122;
    }

    .task-group.task_pending.task_moved {
      background-color: #f0a122;
    }

    .task-group.task_pending.task_deleted {
      background-color: #f0a122;
    }

    /* æ‹–æ‹½æ—¶çš„åŠé€æ˜åé¦ˆ */
    .task-group.dragging {
      opacity: 0.5;
      background: #f0f0f0;
    }

    /* Legend å®¹å™¨ */
    .legend {
      margin: 30px 20px;
      padding-top: 10px;
      border-top: 1px solid #ddd;
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      font-size: 0.9em;
      color: #555;
    }

    /* æ¯ä¸€é¡¹ */
    .legend-item {
      display: flex;
      align-items: center;
    }

    /* å›¾ä¾‹é‡Œçš„å›¾æ ‡ï¼šå¤ç”¨åºŠä½æ ·å¼ï¼Œä½†å›ºå®šå¤§å° */
    .legend-icon {
      display: inline-flex !important;
      width: 24px !important;
      height: 24px !important;
      margin-right: 6px !important;
      padding-left: 0 !important;
    }

    /* è°ƒæ•´ä¼ªå…ƒç´ åœ¨ legend-icon é‡Œçš„ä½ç½® */
    .legend-icon::before {
      left: 2px;
      top: 2px;
      width: 20px;
      height: 20px;
      font-size: 16px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="main">
      <h1>Eè­·å°å¹«æ‰‹ ä»»å‹™ç®¡ç†</h1>
      <div class="tabs">
        <button class="tab-button active" id="5a" onclick="switchTab('5a')">5Aç—…å€</button>
        <button class="tab-button" id="5b" onclick="switchTab('5b')">5Bç—…å€</button>
        <button class="tab-button" id="7b" onclick="switchTab('7b')">7Bç—…å€</button>
      </div>
      <div class="temis">
        <button class="temi-button active" id="Temi1" onclick="switchTemi('Temi1')">Temi 1</button>
        <button class="temi-button" id="Temi2" onclick="switchTemi('Temi2')">Temi 2</button>
      </div>
      <div id="tab-content" class="tab-content">
        è«‹é¸æ“‡ã€Œç—…å€ã€èˆ‡ã€ŒTemiã€
      </div>
      <div id="bed-selection-actions" style="margin-top:10px; text-align:center;">
        <button id="confirm-beds" class="submit-btn">ç¢ºèªåºŠä½</button>
        <button class="submit-btn" style="background:#dc3545;" onclick="clearBedSelection()">æ¸…é™¤å…¨éƒ¨</button>
      </div>
      <!-- æ”¾åœ¨ main æœ€åº•éƒ¨ -->
      <div id="legend-icon" class="legend">
        <div class="legend-item">
          <span class="bed empty legend-icon"></span>
          <span class="legend-label">ç©ºåºŠ</span>
        </div>
        <div class="legend-item">
          <span class="bed ocupied legend-icon"></span>
          <span class="legend-label">æœ‰ç—…æ‚£</span>
        </div>
        <div class="legend-item">
          <span class="bed service legend-icon"></span>
          <span class="legend-label">è­·ç†ç«™</span>
        </div>
      </div>
      <div id="legend-color" class="legend">
        <div class="legend-item">
          <span class="bed task_complete legend-icon"></span>
          <span class="legend-label">å·²å®Œæˆä»»å‹™</span>
        </div>
        <div class="legend-item">
          <span class="bed task_ongoing legend-icon"></span>
          <span class="legend-label">é€²è¡Œä¸­ä»»å‹™</span>
        </div>
        <div class="legend-item">
          <span class="bed task_pending legend-icon"></span>
          <span class="legend-label">å¾…åŸ·è¡Œä»»å‹™</span>
        </div>
        <div class="legend-item">
          <span class="bed task_moved legend-icon"></span>
          <span class="legend-label">é‡æ’åºä»»å‹™</span>
        </div>
        <div class="legend-item">
          <span class="bed task_new legend-icon"></span>
          <!-- <span class="legend-label">æ“¬ç™¼ä½ˆä»»å‹™ (<i>æ–œé«”ï¼šå·²ç™¼ä½ˆ(ä¼ºæœå™¨è³‡æ–™)</i>ï¼› ç²—é«”ï¼šæ–°åŠ å…¥)</span> -->
          <span class="legend-label">æ–°åŠ å…¥ä»»å‹™</span>
        </div>
      </div>
      <div id="legend-font" class="legend">
        <div class="legend-item">
          <span class="legend-label"><i>æ–œé«”: å·²ç™¼ä½ˆ(ä¼ºæœå™¨è³‡æ–™)</i></span>
        </div>
        <div class="legend-item">
          <span class="legend-label"><b>ç²—é«”: æ–°åŠ å…¥</b></span>
        </div>
      </div>
    </div>
    <!-- å·¦å´ä»»å‹™æ¸…å–® -->
    <div class="sidebar">
      <div class="task-list" id="task-list-Temi1">
        <h2>Temi 1 ä»»å‹™åˆ—è¡¨</h2>
      </div>
      <button class="submit-btn" onclick="submitTaskList('Temi1')">ç™¼å¸ƒä»»å‹™è‡³ Temi 1</button>
      <button class="submit-btn" style="background:#dc3545; margin-top:8px;"
        onclick="clearTaskList('Temi1')">æ¸…é™¤åˆ—è¡¨</button>
    </div>
    <!-- å³å´ä»»å‹™æ¸…å–® -->
    <div class="sidebar">
      <div class="task-list" id="task-list-Temi2">
        <h2>Temi 2 ä»»å‹™åˆ—è¡¨</h2>
      </div>
      <button class="submit-btn" onclick="submitTaskList('Temi2')">ç™¼å¸ƒä»»å‹™è‡³ Temi 2</button>
      <button class="submit-btn" style="background:#dc3545; margin-top:8px;"
        onclick="clearTaskList('Temi2')">æ¸…é™¤åˆ—è¡¨</button>
    </div>
  </div>

  <!-- Modal ä»»å‹™é¸æ“‡è¦–çª— -->
  <div id="taskModal" class="modal-overlay">
    <div class="modal">
      <h2>è«‹é¸æ“‡ä»»å‹™</h2>
      <!-- <div class="modal-buttons">
        <button class="modal-task-btn">è¡“å‰æŒ‡å°</button>
        <button class="modal-task-btn">è¡“å¾ŒæŒ‡å°</button>
        <button class="modal-task-btn">é é˜²è·Œå€’</button>
        <button class="modal-task-btn">å¿ƒè‡Ÿæ‰‹è¡“å¾Œè‚©é—œç¯€é‹å‹•</button>
        <button class="modal-task-btn">é—œç¯€é‹å‹•åŠåèµ·æ–¹æ³•</button>
        <button class="modal-task-btn">å¿ƒå°ç®¡æ‰‹è¡“è¡›æ•™å½±ç‰‡</button>
        <button class="modal-task-btn">é«”é‡æ¸¬é‡</button>
        <button class="modal-task-btn">é¤ç›¤æ”¾ç½®è™•</button>
        <button class="modal-task-btn">ç—…åºŠç’°å¢ƒä»‹ç´¹</button>
        <button class="modal-task-btn">å€‹äººç½®ç‰©æ«ƒ</button>
        <button class="modal-task-btn">æ´»åŠ›èµ°å»Š</button>
      </div> -->
      <div id="modalButtons" class="modal-buttons">
        <!-- æŒ‰éˆ•æœƒç”± JS å‹•æ…‹å¡å…¥é€™è£¡ -->
      </div>
      <div id="task-selection-actions" style="margin-top:15px; text-align:center;">
        <button id="confirm-tasks" class="submit-btn">ç¢ºèªä»»å‹™</button>
        <button class="submit-btn" style="background:#dc3545;" onclick="clearTaskSelection()">æ¸…é™¤å…¨éƒ¨</button>
        <button class="submit-btn" style="background:#645e67;" onclick="closeTaskModal()">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <!-- åˆä½µç¢ºèª Modal -->
  <div id="mergeModal" class="modal-overlay">
    <div class="modal">
      <h2>åˆä½µç¢ºèª</h2>
      <p id="mergeMessage" style="margin:15px 0;"></p>
      <div style="text-align:center;">
        <!-- è¿™é‡Œçš„æŒ‰é’®å°±ç”¨ submit-btn -->
        <button id="mergeConfirm" class="submit-btn" style="width:auto; display:inline-block; margin:0 5px;">
          ç¢ºèªåˆä½µ
        </button>
        <button id="mergeCancel" class="submit-btn"
          style="background:#dc3545; width:auto; display:inline-block; margin:0 5px;">
          å–æ¶ˆ
        </button>
      </div>
    </div>
  </div>

  <!-- ä¼ºæœå™¨å›è¦†å½ˆçª— -->
  <div id="responseModal" class="modal-overlay" style="display:none;">
    <div class="modal">
      <h2>ä¼ºæœå™¨å›è¦†</h2>
      <div id="responseContent" style="min-height:60px; margin:10px 0;"></div>
      <button id="closeResponseBtn" class="submit-btn" onclick="closeResponseModal()">ç¢ºèª</button>
    </div>
  </div>

  <script>
    const remote_url = "https://charm.ntuairobo.net:8443/enurse_src/bed_api.php";
    const local_url = "https://localhost/api/bed_api.php";
    let url = local_url;

    let choice_model = "multiple";
    // å–®é¸
    let currentBed = null;  // è¨˜éŒ„ç›®å‰é»æ“Šçš„åºŠä½
    // å¤šé¸
    let dragSrcGroup = null;   // æ‹–æ›³ä¾†æº

    // ç—…å€å…§å®¹è³‡æ–™
    const content = {
      "5a": `   
        <div class="hallway">
          <div class="side">
            <div class="room">
              <h3>Room 1</h3>
              <div class="bed ocupied">01-0</div>
            </div>
            <div class="room">
              <h3>Room 2</h3>
              <div class="bed ocupied">02-0</div>
            </div>
            <div class="room">
              <h3>Room 3</h3>
              <div class="bed ocupied">03-0</div>
            </div>
            <div class="room">
              <h3>Room 5</h3>
              <div class="bed ocupied">05-0</div>
            </div>
          </div>
          <div class="side">
            <div class="room">
              <h3>Room 6</h3>
              <div class="bed ocupied">06-1</div>
              <div class="bed ocupied">06-2</div>
              <div class="bed ocupied">06-3</div>
              <div class="bed ocupied">06-5</div>
            </div>
            <div class="room">
              <h3>Room 7</h3>
              <div class="bed ocupied">07-1</div>
              <div class="bed ocupied">07-2</div>
              <div class="bed ocupied">07-3</div>
              <div class="bed ocupied">07-5</div>
            </div>
            <div class="room">
              <h3>Room 8</h3>
              <div class="bed ocupied">08-1</div>
              <div class="bed ocupied">08-2</div>
              <div class="bed empty">08-3</div>
              <div class="bed empty">08-5</div>
            </div>
            <div class="room">
              <h3>Room 9</h3>
              <div class="bed ocupied">09-1</div>
              <div class="bed ocupied">09-2</div>
              <div class="bed empty">09-3</div>
              <div class="bed empty">09-5</div>
            </div>
          </div>
          <div class="side">
            <div class="room">
              <h3>Room 10</h3>
              <div class="bed ocupied">10-1</div>
              <div class="bed ocupied">10-2</div>
              <div class="bed empty">10-3</div>
              <div class="bed empty">10-5</div>
            </div>
            <div class="room">
              <h3>Room 11</h3>
              <div class="bed ocupied">11-1</div>
              <div class="bed ocupied">11-2</div>
            </div>
            <div class="room">
              <h3>Room 12</h3>
              <div class="bed empty">12-1</div>
              <div class="bed empty">12-2</div>
            </div>
            <div class="room">
              <h3>Room 13</h3>
              <div class="bed ocupied">13-0</div>
            </div>
            <div class="room">
              <h3>Room 15</h3>
              <div class="bed ocupied">15-0</div>
            </div>
            <div class="room">
              <h3>Room 16</h3>
              <div class="bed empty">16-0</div>
            </div>
            <div class="room">
              <h3>Room 17</h3>
              <div class="bed empty">17-0</div>
            </div>
            <div class="room">
              <h3>è­·ç†ç«™</h3>
              <div class="bed service">è­·ç†ç«™</div>
            </div>
          </div>
        </div>
      `,
      "5b": ` 
        <div class="hallway">
          <div class="side">
            <div class="room">
              <h3>Room 1</h3>
              <div class="bed ocupied">01</div>
            </div>
            <div class="room">
              <h3>Room 2</h3>
              <div class="bed ocupied">02</div>
            </div>
            <div class="room">
              <h3>Room 3</h3>
              <div class="bed empty">03</div>
            </div>
            <div class="room">
              <h3>Room 5</h3>
              <div class="bed empty">05</div>
            </div>
            <div class="room">
              <h3>Room 6</h3>
              <div class="bed ocupied">6-1</div>
              <div class="bed ocupied">6-2</div>
              <div class="bed ocupied">6-3</div>
              <div class="bed ocupied">6-5</div>
            </div>
            <div class="room">
              <h3>Room 7</h3>
              <div class="bed ocupied">7-1</div>
              <div class="bed ocupied">7-2</div>
              <div class="bed ocupied">7-3</div>
              <div class="bed ocupied">7-5</div>
            </div>
            <div class="room">
              <h3>Room 8</h3>
              <div class="bed ocupied">8-1</div>
              <div class="bed ocupied">8-2</div>
              <div class="bed empty">8-3</div>
              <div class="bed empty">8-5</div>
            </div>
            <div class="room">
              <h3>Room 9</h3>
              <div class="bed ocupied">9-1</div>
              <div class="bed ocupied">9-2</div>
              <div class="bed empty">9-3</div>
              <div class="bed empty">9-5</div>
            </div>
          </div>
          <div class="side">
            <div class="room">
              <h3>Room 10</h3>
              <div class="bed ocupied">10</div>
            </div>
            <div class="room">
              <h3>Room 11</h3>
              <div class="bed empty">11</div>
            </div>
            <div class="room">
              <h3>Room 12</h3>
              <div class="bed empty">12-1</div>
              <div class="bed empty">12-2</div>
            </div>
            <div class="room">
              <h3>Room 13</h3>
              <div class="bed empty">13-1</div>
              <div class="bed empty">13-2</div>
            </div>
            <div class="room">
              <h3>Room 15</h3>
              <div class="bed empty">15</div>
            </div>
            <div class="room">
              <h3>Room 16</h3>
              <div class="bed empty">16</div>
            </div>
            <div class="room">
              <h3>Room 17</h3>
              <div class="bed empty">17</div>
            </div>
            <div class="room">
              <h3>Room 18</h3>
              <div class="bed empty">18</div>
            </div>
          </div>
        </div>
      `,
      "7b": `   
        <div class="hallway">
          <div class="side">
            <div class="room">
              <h3>Room 1</h3>
              <div class="bed ocupied">01</div>
            </div>
            <div class="room">
              <h3>Room 2</h3>
              <div class="bed ocupied">02</div>
            </div>
            <div class="room">
              <h3>Room 3</h3>
              <div class="bed empty">03</div>
            </div>
            <div class="room">
              <h3>Room 5</h3>
              <div class="bed empty">05</div>
            </div>
            <div class="room">
              <h3>Room 6</h3>
              <div class="bed ocupied">6-1</div>
              <div class="bed ocupied">6-2</div>
              <div class="bed ocupied">6-3</div>
              <div class="bed ocupied">6-5</div>
            </div>
            <div class="room">
              <h3>Room 7</h3>
              <div class="bed ocupied">7-1</div>
              <div class="bed ocupied">7-2</div>
              <div class="bed ocupied">7-3</div>
              <div class="bed ocupied">7-5</div>
            </div>
            <div class="room">
              <h3>Room 8</h3>
              <div class="bed ocupied">8-1</div>
              <div class="bed ocupied">8-2</div>
              <div class="bed empty">8-3</div>
              <div class="bed empty">8-5</div>
            </div>
            <div class="room">
              <h3>Room 9</h3>
              <div class="bed ocupied">9-1</div>
              <div class="bed ocupied">9-2</div>
              <div class="bed empty">9-3</div>
              <div class="bed empty">9-5</div>
            </div>
          </div>
          <div class="side">
            <div class="room">
              <h3>Room 10</h3>
              <div class="bed ocupied">10-1</div>
              <div class="bed ocupied">10-2</div>
              <div class="bed empty">10-3</div>
              <div class="bed empty">10-5</div>
            </div>
            <div class="room">
              <h3>Room 11</h3>
              <div class="bed empty">11-1</div>
              <div class="bed empty">11-2</div>
            </div>
            <div class="room">
              <h3>Room 12</h3>
              <div class="bed empty">12-1</div>
              <div class="bed empty">12-2</div>
            </div>
            <div class="room">
              <h3>Room 13</h3>
              <div class="bed empty">13</div>
            </div>
            <div class="room">
              <h3>Room 15</h3>
              <div class="bed empty">15</div>
            </div>
            <div class="room">
              <h3>Room 16</h3>
              <div class="bed empty">16</div>
            </div>
            <div class="room">
              <h3>Room 17</h3>
              <div class="bed empty">17</div>
            </div>
          </div>
        </div>
      `
    };

    // åˆ‡æ›ç—…å€æ¨™ç±¤ä¸¦æ›´æ–°å…§å®¹ï¼Œä¸¦ç‚ºæ–°ç”¢ç”Ÿçš„åºŠåŠ ä¸Šé»æ“Šäº‹ä»¶
    function switchTab(tabName) {
      document.getElementById("tab-content").innerHTML = content[tabName];
      document.querySelectorAll(".tab-button").forEach(button => {
        button.classList.remove("active");
        if (button.id === tabName) {
          button.classList.add("active");
        }
      });
      attachBedListeners();
    }

    // åˆ‡æ› Temi æ¨™ç±¤
    function switchTemi(tabName) {
      document.querySelectorAll(".temi-button").forEach(button => {
        button.classList.remove("active");
        if (button.id === tabName) {
          button.classList.add("active");
        }
      });
    }

    // é¡¯ç¤º modal
    function showTaskModal() {
      populateModalButtons();
      document.getElementById("taskModal").style.display = "flex";
    }
    // éš±è— modal
    function closeTaskModal() {
      document.getElementById("taskModal").style.display = "none";
      clearBedSelection();
      clearTaskSelection();
    }

    // æŠŠ Java List æ”¹æˆ JS é™£åˆ—
    const taskNames = [
      "å¿ƒå°ç®¡æ‰‹è¡“è¡›æ•™", "å¿ƒå°ç®¡æ‰‹è¡“é€šçŸ¥", "é–‹å¿ƒä¹‹è·¯è¡“å‰æŒ‡å°", "é–‹å¿ƒä¹‹è·¯è¡“å¾ŒæŒ‡å°",
      "å¦‚ä½•åšå€‹å¿«æ¨‚é–‹å¿ƒäºº", "é—œç¯€é‹å‹•åŠåèµ·æ–¹æ³•", "å¿ƒè‡Ÿæ‰‹è¡“å¾Œè‚©é—œç¯€é‹å‹•", "åœ‹èªç‰ˆé é˜²è·Œå€’",
      "å°èªç‰ˆé é˜²è·Œå€’", "å°¿æ¶²æª¢é«”", "ç—°æ¶²æª¢é«”", "å…ç–«æ³•ç³ä¾¿æª¢é«”",
      "Tå‹ç³ä¾¿æª¢é«”", "24å°æ™‚CCR", "12å°æ™‚CCR", "ä¸€èˆ¬æ‰‹è¡“é€šçŸ¥",
      "éœè„ˆæ›²å¼µ", "ä¸»å‹•è„ˆç˜¤", "å‹•è„ˆé˜»å¡", "ç“£è†œæ€§å¿ƒè‡Ÿè¡“å¾Œ",
      "å† ç‹€å‹•è„ˆè¡“å¾Œ", "æŠ½è¡€å¾Œè¡›æ•™"
    ];

    // å‹•æ…‹ç”Ÿæˆ Modal å…§ä»»å‹™é¸é …
    function populateModalButtons() {
      const container = document.getElementById('modalButtons');
      container.innerHTML = ''; // å…ˆæ¸…ç©ºèˆŠæŒ‰éˆ•
      taskNames.forEach(name => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'modal-task-btn';
        btn.textContent = name;
        // åˆ‡æ›é¸ä¸­æ•ˆæœ
        btn.addEventListener('click', () => {
          btn.classList.toggle('selected');
        });
        container.appendChild(btn);
      });
    }

    // ç‚ºæ‰€æœ‰åºŠä½ç¶å®šé»æ“Šäº‹ä»¶
    function attachBedListeners() {
      document.querySelectorAll(".bed").forEach(bed => {
        bed.onclick = () => {
          if (choice_model === "single") {
            // å–®é¸ï¼Œæ‰“å¼€ä»»åŠ¡å¼¹çª— Modal
            currentBed = bed;
            showTaskModal();
          }
          else {
            // å¤šé¸ï¼Œå¯è¦–åŒ–ã€Œå·²é¸ã€
            bed.classList.toggle("selected");
          }
        };
      });
    }

    // æ¸…ç©ºå·²é¸ä¸­çš„åºŠä½
    function clearBedSelection() {
      document.querySelectorAll(".bed.selected")
        .forEach(bed => bed.classList.remove("selected"));
    }

    // å‰µå»º task-group
    function createTaskGroup(container, bedKey, tasks) {
      const group = document.createElement("div");
      group.classList.add("task-group");
      group.setAttribute("data-bed", bedKey);
      group.innerHTML = `<h3>${bedKey}</h3><ul class="task-entries"></ul>`;
      const ul = group.querySelector(".task-entries");

      tasks.forEach(task_name => {
        const li = document.createElement("li");
        li.classList.add("task-entry");

        // æŠŠä»»åŠ¡ååŒ…åœ¨ span é‡Œ
        const span = document.createElement("span");
        span.classList.add("task-text");
        span.textContent = task_name;
        li.appendChild(span);

        // å¦‚æœè¿˜æƒ³ä¿ç•™åˆ é™¤æŒ‰é’®ï¼š
        const btn = document.createElement("button");
        btn.classList.add("remove-btn");
        btn.textContent = "Ã—";
        btn.addEventListener("click", () => li.remove());
        li.appendChild(btn);

        ul.appendChild(li);
      });

      addGroupDragAndDrop(group);
      container.appendChild(group);
    }

    // ç‚ºæ‰€æœ‰ä»»å‹™ç¶å®šé»æ“Šäº‹ä»¶
    function attachTaskListeners() {
      if (choice_model === "single") {
        // å–®é¸ï¼Œç•¶ modal ä¸­ä»»ä¸€ä»»å‹™æŒ‰éˆ•è¢«é»æ“Šæ™‚ï¼Œæäº¤è‡³task-list
        document.querySelectorAll(".modal-task-btn").forEach(btn => {
          btn.addEventListener("click", () => {
            const task = btn.textContent.trim();
            if (!currentBed) return;
            const bedId = currentBed.textContent.trim();
            // æ›´æ–°åºŠä½ç‹€æ…‹
            currentBed.classList.remove("task_pending", "task_ongoing", "task_compelete", "task_failed");
            currentBed.classList.add("task_pending");

            const currentTemi = document.querySelector(".temi-button.active").id;
            const currentRegion = document.querySelector(".tab-button.active").id;
            const taskList = document.getElementById(`task-list-${currentTemi}`);
            const taskKey = `${currentRegion}${bedId}`;
            let taskItem = document.querySelector(`[data-bed='${taskKey}']`);
            if (taskItem) {
              // æ›´æ–°å…§å®¹ (åŒæ™‚ä¿ç•™ remove æŒ‰éˆ•èˆ‡æ‹–æ›³äº‹ä»¶)
              taskItem.querySelector(".content").innerHTML = `<h3>${taskKey}</h3><div>${task}</div>`;
            } else {
              // å»ºç«‹æ–°çš„ä»»å‹™é …ç›®ï¼Œå…§å«å…§å®¹å€èˆ‡åˆªé™¤æŒ‰éˆ•
              const newTask = document.createElement("div");
              newTask.className = "task-item";
              newTask.setAttribute("data-bed", taskKey);
              newTask.innerHTML = `<div class="content"><h3>${taskKey}</h3><div>${task}</div></div>`;
              // æ–°å¢åˆªé™¤æŒ‰éˆ•
              const removeBtn = document.createElement("button");
              removeBtn.textContent = "x";
              removeBtn.className = "remove-btn";
              removeBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                newTask.remove();
              });
              newTask.appendChild(removeBtn);
              taskList.appendChild(newTask);
              addDragAndDrop(newTask);
            }
            closeTaskModal();
          });
        });
      }
      else {
        // å¤šé¸ï¼ŒæŠŠ modal-task-btn ç‚¹å‡»ä»â€œç«‹å³æ·»åŠ â€æ”¹ä¸ºâ€œåˆ‡æ¢ selectedâ€ å¯è¦–åŒ–ã€Œå·²é¸ã€
        document.querySelectorAll(".modal-task-btn").forEach(btn => {
          btn.onclick = () => btn.classList.toggle("selected");
        });
      }
    }

    // æ¸…ç©ºé¸ä¸­çš„ä»»å‹™
    function clearTaskSelection() {
      document.querySelectorAll(".modal-task-btn.selected")
        .forEach(btn => btn.classList.remove("selected"));
    }

    // â€œç¢ºèªåºŠä½â€æŒ‰éˆ•ï¼šæ‰“é–‹ä»»å‹™å½ˆçª— Modal
    document.getElementById("confirm-beds").addEventListener("click", () => {
      const sels = Array.from(document.querySelectorAll(".bed.selected"));
      if (sels.length === 0) {
        alert("è«‹å…ˆé¸ä¸­ä¸€å€‹æˆ–å¤šå€‹åºŠä½");
        return;
      }
      showTaskModal();
    });

    // â€œç¢ºèªä»»å‹™â€æŒ‰éˆ•ï¼šæŠŠé¸ä¸­çš„ä»»å‹™åˆ†é…çµ¦å…ˆå‰é¸ä¸­çš„åºŠä½
    document.getElementById("confirm-tasks").onclick = () => {
      const beds = Array.from(document.querySelectorAll(".bed.selected"));
      const tasks = Array.from(document.querySelectorAll(".modal-task-btn.selected"))
        .map(b => b.textContent.trim());
      if (tasks.length === 0) {
        alert("è«‹å…ˆé¸ä¸­ä¸€å€‹æˆ–å¤šå€‹ä»»å‹™");
        return;
      }
      addTasksToList(beds, tasks);
      closeTaskModal();
    };


    // æ–°å¢æ‹–æ‹½åŠŸèƒ½
    function dragStart(e) {
      dragSrcGroup = this;
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', null); // for Firefox
      this.classList.add("dragging");
    }

    function dragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      return false;
    }

    function drop(e) {
      e.stopPropagation();
      if (dragSrcGroup !== this) {
        let container = this.parentNode;
        let children = Array.from(container.children);
        let srcIndex = children.indexOf(dragSrcGroup);
        let destIndex = children.indexOf(this);
        if (srcIndex < destIndex) {
          container.insertBefore(dragSrcGroup, this.nextSibling);
        } else {
          container.insertBefore(dragSrcGroup, this);
        }
      }
      return false;
    }

    function dragEnd(e) {
      this.classList.remove("dragging");
    }

    // å–®é¸æƒ…æ³çš„æ‹–æ‹½
    function addDragAndDrop(taskItem) {
      taskItem.setAttribute("draggable", true);
      taskItem.addEventListener("dragstart", dragStart, false);
      taskItem.addEventListener("dragover", dragOver, false);
      taskItem.addEventListener("drop", drop, false);
      taskItem.addEventListener("dragend", dragEnd, false);
    }

    // å¤šé¸æƒ…æ³æ™‚ï¼Œç‚ºæ¯å€‹ .task-group æ·»åŠ æ‹–æ‹½åˆä½µåŠŸèƒ½
    function addGroupDragAndDrop(group) {
      group.draggable = true;

      group.addEventListener('dragstart', e => {
        // æ¨™è¨˜ç•¶å‰æ‹–æ‹½çš„çµ„
        dragSrcGroup = group;
        group.classList.add('dragging');
      });

      group.addEventListener('dragover', e => {
        e.preventDefault(); // å¿…é ˆé˜»æ­¢é»˜èªï¼Œæ‰èƒ½è§¸ç™¼ drop
      });

      group.addEventListener('drop', e => {
        e.preventDefault();
        // å¦‚æœæ²’æœ‰æºå…ƒç´ æˆ–æ‹–åˆ°è‡ªå·±ï¼Œå°±ä¸è™•ç†
        if (!dragSrcGroup || dragSrcGroup === group) return;

        const srcBed = dragSrcGroup.getAttribute('data-bed');
        const dstBed = group.getAttribute('data-bed');
        const container = group.parentNode;

        if (srcBed === dstBed) {
          // åŒåºŠä½ï¼šåˆå¹¶ä»»åŠ¡åˆ—è¡¨
          const srcItems = dragSrcGroup.querySelectorAll('.task-entry');
          const dstUl = group.querySelector('.task-entries');
          srcItems.forEach(li => dstUl.appendChild(li));
          group.classList.add("task_moved");
          dragSrcGroup.remove();
        } else {
          // ä¸åŒåºŠä½ï¼šæ ¹æ®é¼ æ ‡ä½ç½®å†³å®šæ’å…¥å‰æˆ–æ’å…¥å
          const { top, height } = group.getBoundingClientRect();
          const offsetY = e.clientY - top;
          if (offsetY < height / 2) {
            container.insertBefore(dragSrcGroup, group);
            dragSrcGroup.classList.add("task_moved");
          } else {
            container.insertBefore(dragSrcGroup, group.nextSibling);
            dragSrcGroup.classList.add("task_moved");
          }
        }
      });

      group.addEventListener('dragend', () => {
        group.classList.remove('dragging');
        dragSrcGroup = null;
      });
    }

    // çµ¦ç¾æœ‰å’Œæ–°å‰µå»ºçš„ .task-group èª¿ç”¨
    // document.querySelectorAll('.task-group').forEach(addGroupDragAndDrop);

    // è©¢å•æ˜¯å¦åˆä½µè‡³å·²å®‰æ’ä»»å‹™åºŠä½çš„.task-group
    /**
     * å½ˆå‡ºåˆä½µç¢ºèªå½ˆçª—ï¼Œè¿”å› Promise<boolean>
     * resolve(true)  => ç”¨æˆ¶é»æ“Šâ€œç¢ºèªåˆä½µâ€
     * resolve(false) => ç”¨æˆ¶é»æ“Šâ€œå–æ¶ˆâ€
     */
    function showMergeModal(message) {
      return new Promise(resolve => {
        // æ˜¾ç¤ºå¹¶è®¾ç½®æ–‡å­—
        mergeMessage.textContent = message;
        mergeModal.style.display = 'flex';

        // äº‹ä»¶å¤„ç†
        const onConfirm = () => finish(true);
        const onCancel = () => finish(false);

        mergeConfirm.addEventListener('click', onConfirm);
        mergeCancel.addEventListener('click', onCancel);

        function finish(result) {
          // éšè—å¼¹çª—ï¼Œç§»é™¤ç›‘å¬
          mergeModal.style.display = 'none';
          mergeConfirm.removeEventListener('click', onConfirm);
          mergeCancel.removeEventListener('click', onCancel);
          resolve(result);
        }
      });
    }

    /**
     * å°‡ä»»å‹™æ’å…¥å³å´åˆ—è¡¨
     * beds: Array of å·²é¸ä¸­çš„åºŠä½ DOM å…ƒç´ 
     * tasks: Array of ä»»å‹™åç¨±ï¼ˆstringï¼‰
     */
    function addTasksToList(beds, tasks) {
      const currentTemi = document.querySelector(".temi-button.active").id;
      const currentRegion = document.querySelector(".tab-button.active").id;
      const taskList = document.getElementById(`task-list-${currentTemi}`);

      beds.forEach(bedEl => {
        // ä¿®æ­£åºŠä½ keyï¼š region-bedName
        const bedKey = `${currentRegion}${bedEl.textContent.trim()}`;

        // æŸ¥æ‰¾æ˜¯å¦å·²æœ‰ç›¸åŒåºŠä½ç»„
        const existingGroup = taskList.querySelector(`.task-group[data-bed="${bedKey}"]`);

        if (existingGroup && !existingGroup.classList.contains("task_ongoing")) {
          // å½ˆçª—è©¢å•æ˜¯å¦åˆä½µ
          showMergeModal(`åºŠä½ ${bedKey} å·²åœ¨åˆ—è¡¨ä¸­ï¼Œæ˜¯å¦å°‡æ–°ä»»å‹™åˆä½µåˆ°å·²æœ‰ç´€éŒ„ï¼Ÿ`)
            .then(merge => {
              if (merge) {
                const ul = existingGroup.querySelector(".task-entries");
                tasks.forEach(task_name => {
                  const li = document.createElement("li");
                  li.className = "task-entry";
                  li.classList.add("new");

                  // æŠŠä»»åŠ¡ååŒ…åœ¨ span é‡Œ
                  const span = document.createElement("span");
                  span.classList.add("task-text");
                  span.textContent = task_name;
                  li.appendChild(span);

                  // æ–°å¢å­ä»»å‹™åˆªé™¤æŒ‰éˆ•
                  const removeBtn = document.createElement("button");
                  removeBtn.textContent = "x";
                  removeBtn.className = "remove-btn";
                  removeBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    li.remove();
                    if (ul.children.length === 0) {
                      existingGroup.remove();
                    }
                  });
                  li.appendChild(removeBtn);

                  ul.appendChild(li);

                  // existingGroup.classList.remove("task_pending");
                  existingGroup.classList.add("task_new");
                });
              } else {
                // ä¸åˆå¹¶ï¼šæ–°å»ºä¸€æ¡ç‹¬ç«‹è®°å½•
                const group = document.createElement("div");
                group.className = "task-group";
                group.setAttribute("data-bed", bedKey);
                group.innerHTML = `
                <h3>${bedKey}</h3>
                <ul class="task-entries"></ul>
              `;
                const ul = group.querySelector(".task-entries");
                tasks.forEach(task_name => {
                  const li = document.createElement("li");
                  li.className = "task-entry";
                  li.classList.add("new");

                  // æŠŠä»»åŠ¡ååŒ…åœ¨ span é‡Œ
                  const span = document.createElement("span");
                  span.classList.add("task-text");
                  span.textContent = task_name;
                  li.appendChild(span);

                  // æ–°å¢å­ä»»å‹™åˆªé™¤æŒ‰éˆ•
                  const removeBtn = document.createElement("button");
                  removeBtn.textContent = "x";
                  removeBtn.className = "remove-btn";
                  removeBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    li.remove();
                    if (ul.children.length === 0) {
                      group.remove();
                    }
                  });
                  li.appendChild(removeBtn);

                  ul.appendChild(li);
                });

                // æ–°å¢åˆªé™¤æŒ‰éˆ•
                const removeBtn = document.createElement("button");
                removeBtn.textContent = "x";
                removeBtn.className = "remove-btn";
                removeBtn.addEventListener("click", (e) => {
                  e.stopPropagation();
                  group.remove();
                });

                group.appendChild(removeBtn);

                addGroupDragAndDrop(group);
                taskList.appendChild(group);

                group.classList.add("task_new");
              }
            });
        } else {

          // æ–°å»ºä¸€å€‹åºŠä½ç»„å®¹å™¨
          const group = document.createElement("div");
          group.className = "task-group";
          group.setAttribute("data-bed", bedKey);
          group.innerHTML = `
            <h3>${bedKey}</h3>
            <ul class="task-entries"></ul>
          `;

          // é€ä¸€æ·»åŠ ä»»åŠ¡ li
          const ul = group.querySelector(".task-entries");
          tasks.forEach(task_name => {
            const li = document.createElement("li");
            li.className = "task-entry";
            li.classList.add("new");

            // æŠŠä»»åŠ¡ååŒ…åœ¨ span é‡Œ
            const span = document.createElement("span");
            span.classList.add("task-text");
            span.textContent = task_name;
            li.appendChild(span);

            // æ–°å¢å­ä»»å‹™åˆªé™¤æŒ‰éˆ•
            const removeBtn = document.createElement("button");
            removeBtn.textContent = "x";
            removeBtn.className = "remove-btn";
            removeBtn.addEventListener("click", (e) => {
              e.stopPropagation();
              li.remove();
              if (ul.children.length === 0) {
                group.remove();
              }
            });
            li.appendChild(removeBtn);

            ul.appendChild(li);
          });

          // æ–°å¢åˆªé™¤æŒ‰éˆ•
          const removeBtn = document.createElement("button");
          removeBtn.textContent = "x";
          removeBtn.className = "remove-btn";
          removeBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            group.remove();
          });
          group.appendChild(removeBtn);

          // åˆå§‹åŒ–æ‹–æ‹½åˆå¹¶
          addGroupDragAndDrop(group);
          taskList.appendChild(group);

          group.classList.add("task_new");
        }

        // æ¨™è¨˜åºŠä½æœ‰å¾…åŸ·è¡Œä»»å‹™
        bedEl.classList.add("task_new");
      });
    }

    /**
     * å°†è‡ªå‹•åŒæ­¥çš„ä¼ºæœå™¨ç´€éŒ„ä»»åŠ¡æ’å…¥å³ä¾§åˆ—è¡¨
     * values: Array of ä»»åŠ¡
     */
    function renderFetchedTasks(values) {
      // const currentTemi = document.querySelector(".temi-button.active").id;
      // const taskList = document.getElementById(`task-list-${currentTemi}`);
      const taskList = document.getElementById(`task-list-Temi1`);
      taskList.innerHTML = "<h2>Temi 1 ä»»å‹™åˆ—è¡¨</h2>"; // æ¸…ç©ºèˆŠä»»å‹™

      values.forEach(bed => {
        const { _, floor, room_number, bed_name, bed_id, tasks, status } = bed;

        // å˜—è©¦å°‡ tasks è½‰æˆé™£åˆ—
        let parsedTasks = [];

        if (Array.isArray(tasks)) {
          parsedTasks = tasks;
          // //for debug
          // document.getElementById("responseContent").textContent = "âš ï¸ä»»å‹™ is Array:" + tasks;
          // showResponseModal();
        } else if (typeof tasks === "string") {
          // //for debug
          // document.getElementById("responseContent").textContent = "âš ï¸ä»»å‹™ is string:" + tasks;
          // showResponseModal();

          try {
            const t = JSON.parse(tasks);
            if (Array.isArray(t)) {
              parsedTasks = t;
              // //for debug
              // document.getElementById("responseContent").textContent = "âš ï¸ä»»å‹™ is Array:" + tasks;
              // showResponseModal();
            }
          } catch (e) {
            console.warn("âš ï¸ ç„¡æ³•è§£æä»»å‹™ JSON å­—ä¸²ï¼š", tasks);
            // //for debug
            // document.getElementById("responseContent").textContent = "âš ï¸ ç„¡æ³•è§£æä»»å‹™ JSON å­—ä¸²ï¼š" + tasks;
            // showResponseModal();
          }
        }

        // æ¨™è¨˜åºŠä½æœ‰å¾…åŸ·è¡Œä»»å‹™
        document.querySelectorAll(".bed").forEach(bed => {
          if (bed.textContent.trim() === bed_name) {
            bed.classList.remove("task_new", "task_pending", "task_ongoing", "task_complete", "task_failed");
            if (status === "pending")
              bed.classList.add("task_pending");
            if (status === "ongoing")
              bed.classList.add("task_ongoing");
            if (status === "complete")
              bed.classList.add("task_complete");
          }
        });

        // å»ºç«‹ group å®¹å™¨
        const group = document.createElement("div");
        group.className = "task-group";
        group.setAttribute("data-bed", bed_id);
        group.innerHTML = `
          <h3>${bed_id}</h3>
          <ul class="task-entries"></ul>
        `;

        // æ’å…¥ä»»å‹™åˆ—è¡¨
        const ul = group.querySelector(".task-entries");
        parsedTasks.forEach(task => {
          const li = document.createElement("li");
          li.className = "task-entry";
          li.classList.add("render");

          // æŠŠä»»åŠ¡ååŒ…åœ¨ span é‡Œ
          const span = document.createElement("span");
          span.classList.add("task-text");
          span.textContent = task.task_name || "(æœªçŸ¥ä»»å‹™)";
          li.appendChild(span);

          // æ–°å¢å­ä»»å‹™åˆªé™¤æŒ‰éˆ•
          if (status !== "complete" && status !== "ongoing") {
            const removeBtn = document.createElement("button");
            removeBtn.textContent = "x";
            removeBtn.className = "remove-btn";
            removeBtn.addEventListener("click", (e) => {
              e.stopPropagation();

              if (group.classList.contains("task_ongoing")) {
                alert("ç„¡æ³•åˆªé™¤æ­£åœ¨é€²è¡Œçš„ä»»å‹™");
                return;
              }

              else if (group.classList.contains("task_pending")) {
                // 1. è·³å‡ºç¢ºèªå°è©±æ¡†
                const ok = confirm("é€™é …ä»»å‹™å°šæœªåŸ·è¡Œï¼Œç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ");
                if (!ok) return;

                // 2. å–å‡º task_idï¼ˆä½ è¦å…ˆåœ¨å»ºç«‹ group æ™‚åŠ ä¸Š data-task-idï¼‰
                const bedId = group.getAttribute("data-bed");
                if (!bedId) {
                  alert("æ‰¾ä¸åˆ°åºŠä½ä»»å‹™ï¼Œç„¡æ³•åˆªé™¤");
                  return;
                }

                const values = parsedTasks.filter(t => t.task_name !== task.task_name);
                if (values.length === 0) {
                  action = "delete";
                } else {
                  action = "update";
                  group.classList.add("task_deleted");
                }

                // 3. ç™¼ DELETE è«‹æ±‚åˆ°ä½ çš„ API
                fetch(url, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    data_type: "table_enurse_beds",
                    action: action,
                    values: [{
                      bed_id: bedId,
                      tasks: parsedTasks.filter(t => t.task_name !== task.task_name)
                    }]
                  })
                })
                  .then(res => res.json())
                  .then(data => {
                    if (data.values) {
                      // 4. å¾Œç«¯åˆªé™¤æˆåŠŸï¼Œå†å¾å‰ç«¯ç§»é™¤
                      if (data.values.length > 0) {
                        alert("åˆªé™¤æˆåŠŸ");
                      } else {
                        alert("åˆªé™¤å¤±æ•—ï¼šæ‰¾ä¸åˆ°è©²ä»»å‹™");
                      }
                      group.remove();
                    } else {
                      alert("åˆªé™¤å¤±æ•—ï¼š" + (json.error || "æœªçŸ¥éŒ¯èª¤"));
                    }
                  })
                  .catch(err => {
                    console.error(err);
                    alert("ä¼ºæœå™¨æˆ–ç¶²è·¯éŒ¯èª¤ï¼Œç„¡æ³•åˆªé™¤");
                  });

                return;
              }

              else {
                // ç›´æ¥åˆªé™¤
                group.remove();
              }
            });

            if (ul.children.length === 0) {
              group.remove();
              // bed.classList.remove("task_pending");
            }

            li.appendChild(removeBtn);
          }

          ul.appendChild(li);
        });

        // åŠ å…¥åˆªé™¤æŒ‰éˆ•
        if (status !== "complete" && status !== "ongoing") {
          const removeBtn = document.createElement("button");
          removeBtn.textContent = "x";
          removeBtn.className = "remove-btn";
          removeBtn.addEventListener("click", (e) => {
            e.stopPropagation();

            if (group.classList.contains("task_ongoing")) {
              alert("ç„¡æ³•åˆªé™¤æ­£åœ¨é€²è¡Œçš„ä»»å‹™");
              return;
            }

            else if (group.classList.contains("task_pending")) {
              // 1. è·³å‡ºç¢ºèªå°è©±æ¡†
              const ok = confirm("é€™é …ä»»å‹™å°šæœªåŸ·è¡Œï¼Œç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ");
              if (!ok) return;

              // 2. å–å‡º task_idï¼ˆä½ è¦å…ˆåœ¨å»ºç«‹ group æ™‚åŠ ä¸Š data-task-idï¼‰
              const bedId = group.getAttribute("data-bed");
              if (!bedId) {
                alert("æ‰¾ä¸åˆ°åºŠä½ä»»å‹™ï¼Œç„¡æ³•åˆªé™¤");
                return;
              }

              // 3. ç™¼ DELETE è«‹æ±‚åˆ°ä½ çš„ API
              fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  data_type: "table_enurse_beds",
                  action: "delete",
                  values: [{ bed_id: bedId }]
                })
              })
                .then(res => res.json())
                .then(data => {
                  if (data.values) {
                    // 4. å¾Œç«¯åˆªé™¤æˆåŠŸï¼Œå†å¾å‰ç«¯ç§»é™¤
                    if (data.values.length > 0) {
                      alert("åˆªé™¤æˆåŠŸ");
                      group.remove();
                      values.forEach(bed => {
                        const { bed_id, status } = bed;
                        document.querySelectorAll(".bed.task_pending").forEach(bedEl => {
                          if (bedEl.textContent.trim() === bed_id.slice(2)) {
                            bedEl.classList.remove("task_pending");
                          }
                        });
                      });
                      const contentDiv = document.getElementById("responseContent");
                      contentDiv.textContent = typeof data === "object"
                        ? JSON.stringify(data, null, 2)
                        : data;
                      showResponseModal();
                    } else {
                      alert("åˆªé™¤å¤±æ•—ï¼šæ‰¾ä¸åˆ°è©²ä»»å‹™");
                    }
                  } else {
                    alert("åˆªé™¤å¤±æ•—ï¼š" + (json.error || "æœªçŸ¥éŒ¯èª¤"));
                  }
                })
                .catch(err => {
                  console.error(err);
                  alert("ä¼ºæœå™¨æˆ–ç¶²è·¯éŒ¯èª¤ï¼Œç„¡æ³•åˆªé™¤");
                });

              return;
            }

            else {
              // ç›´æ¥åˆªé™¤
              group.remove();
              // bed.classList.remove("task_pending");
            }
          });
          group.appendChild(removeBtn);
        }

        // å•Ÿç”¨æ‹–æ›³åŠŸèƒ½
        if (status === "pending") {
          addGroupDragAndDrop(group);
        }

        taskList.appendChild(group);
        group.classList.add("task_" + status);
      });
    }



    // æ¸…é™¤æŒ‡å®š Temi çš„ task-list å…§æ‰€æœ‰ .task-group
    // @param {string} temiId 'Temi1' æˆ– 'Temi2'
    function clearTaskList(temiId) {
      const listDiv = document.getElementById(`task-list-${temiId}`);
      // æ‰¾åˆ°æ‰€æœ‰ task-groupï¼Œé€ä¸€ç§»é™¤
      listDiv.querySelectorAll('.task-group').forEach(group => group.remove());
    }

    // é¡¯ç¤ºå½ˆçª—
    function showResponseModal() {
      document.getElementById("responseModal").style.display = "flex";
    }

    // éš±è—å½ˆçª—
    function closeResponseModal() {
      document.getElementById("responseModal").style.display = "none";

      fetch(url, {
        mode: "cors",
        method: "POST",
        credentials: "include",
        headers: {
          "Content-Type": "application/json",
          ...getHeaders()
        },
        body: JSON.stringify({
          data_type: "table_enurse_beds",
          action: "get_all",
          values: [{}]
        })
      })
        .then(res => res.json())
        .then(data => {
          if (Array.isArray(data.values)) {
            renderFetchedTasks(data.values);
          }
        })
        .catch(err => {
          console.error("è‡ªå‹•è¼‰å…¥ä»»å‹™å¤±æ•—ï¼š", err);
        });
    }

    /**
     * ä» bedKey ä¸­è¿˜åŸ floorã€room_numberã€bed_name
     * @param {string} bedKey e.g. "5a09-3"
     */
    function parseBedKey(bedKey) {
      if (!bedKey || bedKey.length < 3) {
        throw new Error("bedKey æ ¼å¼éŒ¯èª¤");
      }
      const floor = bedKey.slice(0, 2);                  // "5a"
      const bed_name = bedKey.slice(2);                  // "09-3"
      const [room_number] = bed_name.split('-');         // "09"
      const bed_id = bedKey                              // "5a09-3"
      return { floor, room_number, bed_name, bed_id };
    }


    /**
     * è¿”å›åŒ…å« Basic Authorization çš„ headers å¯¹è±¡
     * username å’Œ password å»ºè®®ä»å®‰å…¨å­˜å‚¨æˆ–ç¯å¢ƒå˜é‡ä¸­è¯»å–
     */
    function getHeaders() {
      // TODO
      const u_id = '';
      const p_id = '';

      // JS åŸç”Ÿ btoa å®ç° Base64 ç¼–ç 
      const creds = `${u_id}:${p_id}`;
      const auth = 'Basic ' + btoa(creds);

      return {
        'Authorization': auth
      };
    }

    /**
     * æ”¶é›†æ‰€æœ‰ task-groupã€æ•´ç†ä¸ºåç«¯éœ€è¦çš„ payload å¹¶æ‰“åŒ…å‘é€
     */
    function submitTaskList(temi) {
      const taskListDiv = document.getElementById(`task-list-${temi}`);
      const groups = taskListDiv.querySelectorAll(".task-group");
      // const bedTasksMap = {};
      const values = []

      groups.forEach(group => {
        if (!group.classList.contains("task_ongoing")) {
          // è¯»å– data-bed å¹¶æ‹†æˆ floor + bed_name
          const key = group.getAttribute("data-bed");        // e.g. "5a01-0"
          const { floor, room_number, bed_name, bed_id } = parseBedKey(key);

          // ä» .task-entry.task-text é€æ¡è¯»å‡º task_name
          const entries = Array.from(group.querySelectorAll(".task-entry .task-text"))
            .map(span => span.textContent.trim())
            .filter(s => s);;

          // æ„é€ æ¯é¡¹ä»»åŠ¡ object
          const tasks = entries.map(task_name => ({
            task_name,
            status: "pending",
            created_at: Date.now(),
            start_time: 0,
            finish_time: 0
          }));

          if (tasks.length) {
            // bedTasksMap[key] = { floor, room_number, bed_name, bed_id, tasks };
            values.push({ floor, room_number, bed_name, bed_id, tasks });
          }
        }
      });

      // å¦‚æœæ²’æœ‰ä»»å‹™å°±ä¸ç™¼
      // if (Object.keys(bedTasksMap).length === 0) {
      //   return alert("ç›®å‰æ²’æœ‰å¯æäº¤çš„ä»»å‹™ï¼");
      // }
      if (values.length === 0) {
        return alert("ç›®å‰æ²’æœ‰å¯æäº¤çš„ä»»å‹™ï¼");
      }

      const payload = {
        data_type: "table_enurse_beds",
        action: "insert",
        values: values
      };

      // ç™¼é€è«‹æ±‚
      // TODO: httpsç¶²é ç„¡æ³•ç™¼é€çµ¦http
      // const url = "http://140.112.95.5:8099/task_api.php"

      // Object.values(bedTasksMap).forEach(({ floor, room_number, bed_name, bed_id, tasks }) => {
      fetch(url, {
        mode: "cors",
        method: "POST",
        credentials: "include",
        headers: {
          "Content-Type": "application/json; charset=utf-8",
          ...getHeaders()
        },
        body: JSON.stringify(payload)
      })
        .then(res => res.json())
        .then(data => {
          const contentDiv = document.getElementById("responseContent");
          contentDiv.textContent = typeof data === "object"
            ? JSON.stringify(data, null, 2)
            : data;
          showResponseModal();
        })
        .catch(err => {
          document.getElementById("responseContent").textContent = "é€šè¨ŠéŒ¯èª¤ï¼š" + err;
          showResponseModal();
        });
      // // debug
      // .then(response => response.text()) // âœ… ä¸ç”¨ json è§£æ
      // .then(text => {
      //   // ç›´æ¥å¡é€² modalã€å½ˆçª—ã€div ç­‰
      //   document.getElementById("responseContent").textContent = text;
      //   showResponseModal();
      // })
      // .catch(err => {
      //   document.getElementById("responseContent").textContent = "é€šè¨ŠéŒ¯èª¤ï¼š" + err.message;
      //   showResponseModal();
      // });
      // });
    }

    async function fetchTableBeds(data) {
      try {
        const response = await fetch(url, {
          mode: "cors",
          method: "POST",
          credentials: "include", // è‹¥éœ€è¦ cookie / Basic Auth
          headers: {
            "Content-Type": "application/json",
            ...getHeaders()
          },
          body: JSON.stringify(data)
        });

        // æª¢æŸ¥æ˜¯å¦æˆåŠŸ
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const contentType = response.headers.get("Content-Type") || "";
        if (!contentType.includes("application/json")) {
          throw new Error("å›æ‡‰ä¸æ˜¯ JSON æ ¼å¼");
        }

        const text = await response.text();
        if (text.trim() === "") {
          throw new Error("ä¼ºæœå™¨å›æ‡‰ç‚ºç©º");
        }

        const result = JSON.parse(text);

        // âœ… æˆåŠŸå¾Œçš„è™•ç†é‚è¼¯
        if (result.values) {
          console.log("æ¥æ”¶åˆ°è³‡æ–™ï¼š", result.values);
        } else {
          console.warn("è³‡æ–™æ ¼å¼ä¸ç¬¦ï¼š", result);
        }

      } catch (err) {
        console.error("é€šè¨ŠéŒ¯èª¤ï¼š", err.message);
      }
    }


    // åˆå§‹è¨­å®šï¼šé è¨­é¸æ“‡ Temi1 èˆ‡ 5A ç—…å€
    document.addEventListener("DOMContentLoaded", () => {
      switchTemi("Temi1");
      switchTab("5a");

      fetch(url, {
        mode: "cors",
        method: "POST",
        credentials: "include",
        headers: {
          "Content-Type": "application/json",
          ...getHeaders()
        },
        body: JSON.stringify({
          data_type: "table_enurse_beds",
          action: "get_all",
          values: [{}]
        })
      })
        .then(res => res.json())
        .then(data => {
          if (Array.isArray(data.values)) {
            renderFetchedTasks(data.values);
          }
        })
        .catch(err => {
          console.error("è‡ªå‹•è¼‰å…¥ä»»å‹™å¤±æ•—ï¼š", err);
        });
      // // for debug
      // .then(response => response.text()) // âœ… ä¸ç”¨ json è§£æ
      // .then(text => {
      //   // ç›´æ¥å¡é€² modalã€å½ˆçª—ã€div ç­‰
      //   document.getElementById("responseContent").textContent = text;
      //   showResponseModal();
      // })
      // .catch(err => {
      //   document.getElementById("responseContent").textContent = "é€šè¨ŠéŒ¯èª¤ï¼š" + err.message;
      //   showResponseModal();
      // });
    });
  </script>
</body>

</html>